\documentclass{scrreprt}

% packages
\usepackage{amsmath}
%\usepackage{enumitem}
\usepackage[margin=0.8in]{geometry}
\usepackage{graphics}
\usepackage{graphicx}
\usepackage[round]{natbib}
\usepackage{pst-node}

% settings
\bibliographystyle{plainnat}
\setkomafont{sectioning}{\normalfont\bfseries}
%\setlist[itemize]{noitemsep}
\newenvironment{denseitem}{
  \begin{itemize}
    \setlength{\itemsep}{0pt}
    \setlength{\parskip}{0pt}
    \setlength{\parsep}{0pt}
}{
  \end{itemize}
}

\title{Evapotranspiration Modeling in ECHSE: Documentation}
\author{Julius Eberhard}

%::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

\begin{document}

\maketitle
\tableofcontents

%................................................................................

\chapter{Introduction} \label{ch:introduction}

This is a documentation of my work done in exploring some aspects of the way how evapotranspiration is simulated in the \emph{Eco-Hydrological Simulation Environment} (ECHSE, \citealt{kneis15}) with methods, classes, and engines written by Tobias Pilz.
ECHSE is a model framework, i.e. a software providing calculation methods that can be composed modularly to form model engines. These engines can be compiled and be run as independent models with input data.
ECHSE is used in the field of (eco-) hydrology and therefore comes with a collection of methods especially relevant for issues in this field.
The goal of the bigger project is to apply with ECHSE different ways of determining the potential ($et_{pot}$) and the actual evapotranspiration ($et_{act}$).
These are, as of the date of this documentation:
\begin{itemize}
  \item[--] the simple model of \citet{makkink57},
  \item[--] the equation of Penman \& Monteith \citep{monteith65},
  \item[--] the FAO Penman-Monteith equation (``reference evaporation''),
  \item[--] the equation of Shuttleworth \& Wallace \citep{shuttleworth85}.
\end{itemize}

The engine-specific names of variables and parameters are written in \verb!fixed-width! whereas the physical symbols of variables, constants and parameters are written in \textit{italics}.
E.g., extraterrestrial radiation = $R_{ex}$ = \verb!radex!.
Terms that describe parts of the ECHSE architecture are written in \textsf{sans-serif}.

\section{Model overview -- parameter overview} \label{sec:intro_overview}

The engine parameters can be grouped into
\begin{itemize}
  \item[--] aerodynamic parameters,
  \item[--] geographical parameters,
  \item[--] radiation parameters,
  \item[--] soil hydraulic parameters,
  \item[--] vegetation parameters,
\end{itemize}
%
according to their physical role, and will be discussed in this order in chapter \ref{ch:parest}.
Within the ECHSE engines, parameters are grouped into the types
\begin{itemize}
  \item[--] \textsf{paramNum} (object-specific scalar parameters),
  \item[--] \textsf{sharedParamNum} (group-specific scalar parameters),
  \item[--] \textsf{inputExt} (group-specific time-dependent scalar parameters treated as external input variables),
\end{itemize}
%
according to their role in the computation process.
Tab. \ref{tab:varpar} contains an overview of the variables and parameters and whether they are used in the different $et$ models (Makk = Makkink, PM = Penman-Monteith, FAO = FAO Penman-Monteith, SW = Shuttleworth-Wallace model).
The parameters in this overview are grouped into the types \textsf{paramNum}, \textsf{sharedParamNum}.
Parameters of the \textsf{inputExt} type can be found together with the actual external input variables.

\begin{table}[ht]
  \caption{External input variables, parameters and their usage in the $et$ models.
           For abbreviations, see text.
           \textbullet: required by engine primarily, $\circ$: required only in cases when primary input is missing.}
  \scalebox{0.7}{%
    \begin{tabular*}{0.70\hsize}{cccc|ccc|r}
      \hline
      \multicolumn{4}{c}{$et_{pot}$}                                & \multicolumn{3}{c}{$et_{act}$}  & \\
      Makk          & PM            & FAO           & SW            & PM          & FAO & SW          & ECHSE name \\
      \hline
                    &               &               &               &             &     &             & \textbf{\textsf{inputExt}} \\
                    & $\circ$       & $\circ$       & $\circ$       &             &     &             & \texttt{alb} \\
      \textbullet   & \textbullet   & \textbullet   & \textbullet   &             &     &             & \texttt{apress} \\
                    & \textbullet   &               & \textbullet   &             &     &             & \texttt{cano\_height} \\
      $\circ$       & $\circ$       & $\circ$       & $\circ$       &             &     &             & \texttt{cloud}* \\
      $\circ$       & $\circ$       & $\circ$       & $\circ$       &             &     &             & \texttt{doy} \\
      \textbullet   & \textbullet   & $\circ$       & \textbullet   &             &     &             & \texttt{glorad} \\
                    & $\circ$       & $\circ$       & $\circ$       &             &     &             & \texttt{glorad\_max} \\
      $\circ$       & $\circ$       & $\circ$       & $\circ$       &             &     &             & \texttt{hour} \\
                    & \textbullet   &               & \textbullet   &             &     &             & \texttt{lai} \\
                    & $\circ$       & $\circ$       & $\circ$       &             &     &             & \texttt{rad\_long} \\
                    & \textbullet   & \textbullet   & \textbullet   &             &     &             & \texttt{rad\_net} \\
                    & $\circ$       & $\circ$       & \textbullet   &             &     &             & \texttt{rad\_net\_soil} \\
                    & \textbullet   & \textbullet   & \textbullet   &             &     &             & \texttt{rhum} \\
                    & \textbullet   &               & \textbullet   &             &     &             & \texttt{soilheat} \\
      $\circ$       & $\circ$       & $\circ$       & $\circ$       &             &     &             & \texttt{sundur} \\
      $\circ$       & $\circ$       & $\circ$       & $\circ$       &             &     &             & \texttt{temp\_max} \\
      $\circ$       & $\circ$       & $\circ$       & $\circ$       &             &     &             & \texttt{temp\_min} \\
      \textbullet   & \textbullet   & \textbullet   & \textbullet   &             &     &             & \texttt{temper} \\
                    &               &               & \textbullet   &             &     &             & \texttt{totalheat} \\
      $\circ$       & $\circ$       & $\circ$       & $\circ$       &             &     &             & \texttt{utc\_add} \\
                    &               &               &               &             &     &             & \texttt{wc\_vol\_root} \\
                    &               &               &               &             &     &             & \texttt{wc\_vol\_top} \\
                    & \textbullet   & \textbullet   & \textbullet   &             &     &             & \texttt{wind} \\
      \hline
                    &               &               &               &             &     &             & \textbf{\textsf{paramNum}} \\
                    & \textbullet   &               & \textbullet   &             &     &             & \texttt{bubble} \\
                    &               & \textbullet   &               &             &     &             & \texttt{crop\_faoref} \\
      \textbullet   &               &               &               &             &     &             & \texttt{crop\_makk} \\
      $\circ$       & $\circ$       & $\circ$       & $\circ$       &             &     &             & \texttt{elev} \\
                    & \textbullet   &               & \textbullet   &             &     &             & \texttt{glo\_half} \\
      $\circ$       & $\circ$       & $\circ$       & $\circ$       &             &     &             & \texttt{lat} \\
                    & $\circ$       & $\circ$       & $\circ$       &             &     &             & \texttt{lon} \\
                    &               &               &               & \textbullet &     & \textbullet & \texttt{par\_stressHum} \\
                    &               &               &               & \textbullet &     & \textbullet & \texttt{pores\_ind} \\
                    & \textbullet   &               & \textbullet   &             &     &             & \texttt{res\_leaf\_min} \\
                    &               &               & \textbullet   &             &     &             & \texttt{soil\_dens} \\
                    &               &               &               &             &     &             & \texttt{wc\_etmax} \\
                    &               &               &               &             &     &             & \texttt{wc\_pwp} \\
                    &               &               &               &             &     &             & \texttt{wc\_res} \\
                    &               &               &               &             &     &             & \texttt{wc\_sat} \\
                    &               &               &               &             &     &             & \texttt{wstressmax} \\
                    &               &               &               &             &     &             & \texttt{wstressmin} \\
      \hline
                    &               &               &               &             &     &             & \textbf{\textsf{sharedParamNum}} \\
      \textbullet   & \textbullet   & \textbullet   & \textbullet   &             &     &             & \texttt{choice\_et} \\
                    & $\circ$       & $\circ$       & $\circ$       &             &     &             & \texttt{choice\_gloradmax} \\
                    & \textbullet   &               & \textbullet   &             &     &             & \texttt{choice\_plantDispl} \\
                    & \textbullet   &               & \textbullet   &             &     &             & \texttt{choice\_rcs} \\
                    & \textbullet   &               & \textbullet   &             &     &             & \texttt{choice\_roughLen} \\
                    & \textbullet   &               & \textbullet   &             &     &             & \texttt{drag\_coef} \\
                    &               &               & \textbullet   &             &     &             & \texttt{eddy\_decay} \\
                    & $\circ$       & $\circ$       & $\circ$       &             &     &             & \texttt{emis\_a} \\
                    & $\circ$       & $\circ$       & $\circ$       &             &     &             & \texttt{emis\_b} \\
                    & \textbullet   &               & \textbullet   &             &     &             & \texttt{ext} \\
                    & $\circ$       & $\circ$       & \textbullet   &             &     &             & \texttt{f\_day} \\
                    & $\circ$       & $\circ$       & \textbullet   &             &     &             & \texttt{f\_night} \\
                    & $\circ$       & $\circ$       & $\circ$       &             &     &             & \texttt{fcorr\_a} \\
                    & $\circ$       & $\circ$       & $\circ$       &             &     &             & \texttt{fcorr\_b} \\
                    & \textbullet   &               &               &             &     &             & \texttt{h\_humMeas} \\
                    & \textbullet   &               &               &             &     &             & \texttt{h\_tempMeas} \\
                    & \textbullet   & \textbullet   & \textbullet   &             &     &             & \texttt{h\_windMeas} \\
      $\circ$       & $\circ$       & $\circ$       & $\circ$       &             &     &             & \texttt{radex\_a} \\
      $\circ$       & $\circ$       & $\circ$       & $\circ$       &             &     &             & \texttt{radex\_b} \\
                    &               &               & \textbullet   &             &     &             & \texttt{res\_b} \\
                    & \textbullet   &               & \textbullet   &             &     &             & \texttt{rough\_bare} \\
                    &               &               & \textbullet   &             &     &             & \texttt{rss\_a} \\
                    &               &               & \textbullet   &             &     &             & \texttt{rss\_b} \\
    \hline
                    &               &               &               &             &     &             & *\emph{currently not used}
    \end{tabular*}%
  }
  \label{tab:varpar}
\end{table}

In chapter \ref{ch:results}, an overview of the estimated parameter values is given, grouped into the \textsf{paramNum}, \textsf{sharedParamNum}, and \textsf{inputExt} parameter types.

\section{Study areas -- available data} \label{sec:intro_areas}

\subsection{Portugal} \label{ssec:intro_areas_portugal}

The \emph{Machoqueira do Grou} area is a 2,500~ha sized woodland in the Santar\'em district, between the towns of Coruche and Foros do Arr$\tilde{\text{a}}$o, Portugal.
The vegetation is dominated by cork oak trees and grasses.
A part of the data comes from two measurement stations within the woodland, which were set up for recording eddy covariance data with measurement towers and other meteorological variables.
One station is located between trees under the open sky (\emph{Hauptstation}, HS), the other was set up under a cork oak (\emph{Nebenstation A}, NSA).
The data include net total radiation, air temperature, soil moisture content, sensible heat flux, latent heat flux, vapor pressure deficit, vapor pressure, and wind speed; they were recorded hourly.
An evaporation flux was determined from energy balance considerations.

Additional meteorological data come from a nearby weather station.
Those include photosynthetically active radiation (PAR), incoming short-wave radiation, outgoing long-wave radiation, air temperature, relative humidity, rainfall, and atmospheric pressure; they were recorded half-hourly.

\subsection{Morocco} \label{ssec:intro_areas_morocco}

The study area is a citrus orchard near the village Ait Cheikh, southwest of Marrakesh, lying in the Haouz plain north of the Atlas mountains \citep{mroos14}.
The available data contain relative humidity, global radiation, air temperature, wind speed, and latent heat; they were recorded (latent heat: calculated?) half-hourly.
An evaporation flux was determined from energy balance considerations.
Additionally, soil data were taken from \citet{mroos14}.

%................................................................................

\chapter{Aims} \label{ch:aims}

\begin{itemize}
  \item[--] Estimation of engine parameters through transfer functions and model calibration (chapter \ref{ch:parest}),
  \item[--] comparison of the different $et$ models (chapter \ref{ch:modelcomp}),
  \item[--] sensitivity analysis of engine parameters (chapter \ref{ch:sensana}),
  \item[--] evaluation of single methods employed in the $et$ models (chapter \ref{ch:methodcomp}).
  \item[--] Which input data do we still need? (chapter \ref{ch:conclusion})
\end{itemize}

%................................................................................

\chapter{Parameters: methods and results} \label{ch:parest}

The estimation of \textbf{aerodynamic parameters}, which specify the aerodynamic resistances in the PM and the SW models, was mostly not possible in the study cases and therefore adopted from the original publications.
Nevertheless, the origins of the values are discussed briefly (Sec.~\ref{sec:parest_aero}).

\textbf{Geographical parameters} were given or easy to estimate from map services (Sec.~\ref{sec:parest_geo}).

\textbf{Radiation parameters} were partly estimated from observations of radiation components at the study sites and are discussed more extensively (Sec.~\ref{sec:parest_rad}).

Two pedotransfer functions (PTF) were used to estimate \textbf{soil hydraulic parameters} from the measured soil properties, namely bulk density, mass portions of silt and clay, and organic matter content (Sec.~\ref{sec:parest_soil}).

All \textbf{vegetation parameters} were adapted from other publications or estimated through model calibration (Sec. \ref{sec:parest_veg}).
They are discussed in separate sections to specify the problems and possibilities relevant for their determination.

Where parameters appear in their own sections, the discussion follows the outline \emph{Basics -- Methods -- Notes -- Portugal -- Morocco}.

\section{Aerodynamic parameters} \label{sec:parest_aero}

Below the canopy toward the ground, wind speed is assumed to decrease exponentially with a scaling coefficient $n$, called the \textbf{eddy diffusivity decay constant} (\verb!eddy_decay!); more precisely:
The shearing stress of wind on a horizontal plane is proportional to $\rho \partial u / \partial z$ (where $u$ is the horizontal wind component, $z$ the vertical coordinate, and $\rho$ the density of air) with the proportionality factor $K$.
$n$ relates the magnitude of $K$ at the canopy height to that at the ground.
\citet{shuttleworth85} use a value of $n = 2.5$, arguing that it results from the crop specification made by \citet{monteith73} in deriving the above relation.
Although I couldn't reconstruct this value from the second edition of Monteith's book \citep{monteith90}, \citet{shuttleworth85} concluded from an sensitivity analysis that the resulting evapotranspiration was hardly influenced by changing $n$.
Therefore, $n$ has been set to 2.5.

The \textbf{measurement heights of relative humidity} (\verb!h_humMeas!), \textbf{temperature} (\verb!h_tempMeas!), and \textbf{wind speed} (\verb!h_windMeas!) are known from the measurement setup and each equal to 2~m.

The aerodynamic \textbf{mean boundary layer resistance} $r_b$ (\verb!res_b!) was taken as 25~s~m$^{-1}$ by \citet{shuttleworth85} based on field measurements by \citet{denmead76} and \citet{uchijima76}.
Like for $n$, the models seem to be quite insensitive for variations of $r_b$ \citep{shuttleworth85}, and $r_b$ has been set to 25~s~m$^{-1}$.

In the calculation of the aerodynamic resistance between canopy and reference level, the displacement height of the vegetation and the roughness lengths for latent and sensible heat fluxes of the vegetation are used (see Sec. \ref{sec:parest_veg} for these parameters).
Following \citet{shuttleworth90}, both of these are dependent on the \textbf{roughness length of the bare substrate} $z_0$ (\verb!rough_bare!) and the effective mean \textbf{drag coefficient of the vegetation} $c_d$ (\verb!drag_coef!) as well as on the leaf area index and the canopy height (Sec. \ref{sec:parest_veg}).
The values of $z_0$ and $c_d$ were numerically estimated by the authors and are adopted here as 0.01~m and 0.07, respectively.

All values were employed for both Portugal and Morocco because the aerodynamic conditions are similar.

\section{Geographical parameters} \label{sec:parest_geo}

Each model employs 3 or less geographical parameters for calculating the radiation balance: \textbf{latitude} $\varphi$ (\verb!lat!), \textbf{longitude} $L_m$ (\verb!lon!), \textbf{elevation} $h$ (\verb!elev!).
For the sites in Portugal, the locations were given as UTM coordinates (HS: 557,640.5~m easting, 4,332,523.5~m northing; NSA: 557,717.0~m easting, 4,332,408.0~m northing; both in UTM zone~29S) from which I could derive $\varphi = 39.14^\circ$~N and $L_m= 8.33^\circ$~W for both field stations.
The actual distance of 139~m between the stations corresponds to less than $0.01^\circ$ and was therefore taken as 0.
A common value for $h$ of the Portugal sites was estimated from local elevation maps (\emph{floodmap.net}) as 160~m above sea level.

For Morocco, $\varphi = 31.50^\circ$~N, $L_m = 8.14^\circ$~W, and $h = 464$~m~a.s.l. were taken from \citet{mroos14}.

\section{Radiation parameters} \label{sec:parest_rad}

\subsection{Albedo (\texttt{alb})} \label{ssec:parest_rad_alb}

\textbf{Basics.}
The albedo $\mu$ (\verb!alb!) is defined as
\begin{align*}
  \mu = \frac{R_{inS}}{R_{outS}}
\end{align*}
%
with
\begin{denseitem}
  \item[] $R_{inS}$: incoming short-wave radiation (\verb!glorad!), in W~m$^{-2}$,
  \item[] $R_{outS}$: outgoing short-wave radiation, in W~m$^{-2}$.
\end{denseitem}

\textbf{Method.}
It can be estimated from observations of $R_{inS}$ and $R_{outS}$ or from literature values for various land surfaces.
The albedo of a surface can change over time and is supplied as a time series in ECHSE.

\textbf{Portugal, Morocco.} None of the measurements did include $R_{outS}$ data, so both the albedos in Portugal and Morocco have been estimated as constantly 0.3, judging by the descriptions of the surfaces.
These are likely to have $0.25 < \mu < 0.4$, where 0.25 is the albedo of green grass \citep{markvart03} and 0.4 that of dry sand \citep{tetzlaff83}.

\subsection{Emissivity parameters (\texttt{emis\_a}, \texttt{emis\_b})} \label{ssec:parest_rad_emis}

\textbf{Basics.}
Emissivity is a property of a macroscopic body (fluid or solid) and gives the portion of radiation that the body emits compared with a black body at the same temperature.
There are two methods for calculating the net emissivity $\varepsilon$ between Earth's surface and atmosphere in ECHSE, either from water vapor pressure (Eq.~\ref{eq:emis1}) or from air temperature (Eq.~\ref{eq:emis3}).
The first method includes the emissivity parameters $\varepsilon_a$, $\varepsilon_b$ (\verb!emis_a!, \verb!emis_b!), which represent the average environmental effects (such as surface and climate) on $\varepsilon$ at a certain location:
\begin{align} \label{eq:emis1}
  \varepsilon = \varepsilon_a + \varepsilon_b \sqrt{e}
\end{align}
%
with
\begin{denseitem}
  \item[] $\varepsilon$: net emissivity, no unit,
  \item[] $\varepsilon_a$: emissivity parameter a, no unit,
  \item[] $\varepsilon_b$: emissivity parameter b, in hPa$^{-1/2}$,
  \item[] $e$: water vapor pressure in air, in hPa.
\end{denseitem}
%
$e$ is derived from measurements of the air temperature and the relative humidity.
$\varepsilon$ itself is used in ECHSE for the calculation of the net incoming long-wave radiation:
\begin{align} \label{eq:emis2}
  L_n = -f \varepsilon \sigma (TA + 273.15~\text{K})^4
\end{align}
%
with
\begin{denseitem}
  \item[] $L_n$: net incoming long-wave radiation, in W~m$^{-2}$~K$^{-4}$,
  \item[] $f$: cloudiness correction factor (Sec.~\ref{ssec:parest_rad_fcorr}), no unit,
  \item[] $\varepsilon$: net emissivity between ground and atmosphere, no unit,
  \item[] $\sigma$: Stefan-Boltzmann constant, $5.670373 \times 10^{-8}$~W~m$^{-2}$~K$^{-4}$,
  \item[] ${TA}$: mean air temperature, in $^\circ$C.
\end{denseitem}

\textbf{Method.}
The parameters $\varepsilon_a$, $\varepsilon_b$ can be estimated through Eqs.~\eqref{eq:emis2} and \eqref{eq:emis1} if sufficient data of $L_n$, $TA$, $e$, and $f$ are available.

\textbf{Note.}
The second method for calculating $\varepsilon$ uses air temperature as the only predictor for $\varepsilon$ without the need of $\varepsilon_a$, $\varepsilon_b$, $e$ \citep{maidment93}:
\begin{align} \label{eq:emis3}
  \varepsilon = -0.02 + 0.261 \exp(-7.77 \times 10^{-4} TA^2)
\end{align}
%
(Derivation? $\rightarrow$ \citet{maidment93}, ref. 53)
It seems that Eq.~\eqref{eq:emis1} is the more suitable choice if $e$ is known since it lets the user implement more of the specific environmental conditions at a study site through the emissivity parameters.
However, if $\varepsilon_a$ and $\varepsilon_b$ can't be determined as explained and both $e$ and $TA$ data are available, the question is whether it is better to use Eq.~\eqref{eq:emis1} with average-condition values from \citet{maidment93} or Eq.~\eqref{eq:emis3}.
In ECHSE, Eq.~\eqref{eq:emis1} is preferred as soon as any $e$ data are given as an input and thereby follows the recommendation of \citet{maidment93}.
As can be seen in Sec.~\ref{ssec:parest_rad_fcorr}, the cloudiness correction factor $f$ is determined by two parameters ($f_a$, $f_b$), which need to be supplied by the user.
Their estimation is possible only through the use of Eq.~\eqref{eq:emis2}, thus dependent on $\varepsilon$ data.
This means that a well-founded calculation of the emissivity is the requirement for a good estimation of $f_a$ and $f_b$.
And as both $\varepsilon$ and $f$ are highly empirical factors, ... (\emph{Herleitungen in Maidment \"uberpr\"ufen, dann entscheiden.})

\textbf{Portugal.}
I chose default values of $\varepsilon_a = 0.34$ and $\varepsilon_b = -0.14$, as suggested for average conditions by \citet{maidment93}.
The values could not be estimated specifically because data of the incoming long-wave radiation were missing.

\textbf{Morocco.}
As for Portugal, I chose $\varepsilon_a = 0.34$ and $\varepsilon_b = -0.14$.
The values could not be estimated specifically because data of the net long-wave radiation were missing.

\subsection{Soil heat factors (\texttt{f\_day}, \texttt{f\_night})} \label{ssec:parest_rad_f}

\textbf{Basics.}
Within the ECHSE engines, the sub-daily soil heat flux is currently calculated as
\begin{align}
  G_{soil} &= f_{day} R_{net} ~ \text{during daytime}, \label{eq:f1} \\
  G_{soil} &= f_{night} R_{net} ~ \text{during nighttime}. \label{eq:f2}
\end{align}
%
with
\begin{denseitem}
  \item[] $G_{soil}$: soil heat flux (\verb!soilheat!), in W~m$^{-2}$,
  \item[] $f_{day}$, $f_{night}$: soil heat factors (\verb!f_day!, \verb!f_night!), no unit,
  \item[] $R_{net}$: net incoming short-wave and long-wave radiation (\verb!rad_net!), in W~m$^{-2}$.
\end{denseitem}

\textbf{Portugal.}
Since the data didn't include measurements of $R_{net}$, I used the results of internally calculated values of $R_{net}$ and measurements of $G_{soil}$ for calculating $f_{day}$, $f_{night}$ hourly from Eqs. \eqref{eq:f1}, \eqref{eq:f2}.
The distinction of the time series into daytime and nighttime was made using the \emph{RAtmosphere::suncalc} procedure by Gionata Biavati, which provided sunrise and sunset times for the study site.
Averaging over all hours gave the results.

\textbf{Morocco.}
---

\subsection{Cloudiness correction parameters (\texttt{fcorr\_a}, \texttt{fcorr\_b})} \label{ssec:parest_rad_fcorr}

\textbf{Basics.}
The cloudiness correction parameters $f_a$, $f_b$ (\verb!fcorr_a!, \verb!fcorr_b!) appear as the slope and the intersect parameters of the affine relationship between the cloudiness correction factor $f$ and the relative actual global radiation:
\begin{align} \label{eq:fcorr1}
  f = f_a \frac{R_{inS}}{R_{inS,cs}} + f_b
\end{align}
%
with
\begin{denseitem}
  \item[] $f_a$, $f_b$: cloudiness correction parameters, no unit,
  \item[] $R_{inS}$: actual incoming short-wave radiation (\verb!glorad!), in W~m$^{-2}$,
  \item[] $R_{inS,cs}$: maximum possible (``clear-sky'') incoming short-wave radiation, in W~m$^{-2}$.
\end{denseitem}
%
$f$ itself is used in ECHSE for the calculation of the net incoming long-wave radiation, i.e. Eq.~\eqref{eq:emis2}:
\begin{align*}
  L_n = -f \varepsilon \sigma (TA + 273.15~\text{K})^4
\end{align*}
%
with
\begin{denseitem}
  \item[] $L_n$: net incoming long-wave radiation, in W~m$^{-2}$~K$^{-4}$,
  \item[] $\varepsilon$: net emissivity between atmosphere and ground (Sec.~\ref{ssec:parest_rad_emis}), no unit,
  \item[] $\sigma$: Stefan-Boltzmann constant, $5.670373 \times 10^{-8}$~W~m$^{-2}$~K$^{-4}$,
  \item[] $TA$: mean air temperature, in $^\circ$C.
\end{denseitem}

\textbf{Method.}
The parameters can be estimated from Eq.~\eqref{eq:emis2} if sufficient data of $L_n$, $\varepsilon$, $TA$, $R_{inS}$, and $R_{inS,cs}$ are available.

\textbf{Portugal.}
The cloudiness correction parameters could not be determined because the data from Portugal were not sufficient.
Observations of net long-wave radiation and individual estimations of net emissivity were missing and would have been necessary to make a good estimation.
Missing data of clear-sky radiation, however, could have been derived from actual global radiation data.
I applied the values for arid areas from \citet{maidment93} (p. 4.8), $f_a = 1.35$, $f_b = -0.35$.

\textbf{Morocco.}
The cloudiness correction parameters could not be determined because the data from Morocco were not sufficient.
Observations of net long-wave radiation and individual estimations of net emissivity were missing and would have been necessary to make a good estimation.
Missing data of clear-sky radiation, however, could have been derived from actual global radiation data.
I applied the values for arid areas from \citet{maidment93} (p. 4.8), $f_a = 1.35$, $f_b = -0.35$.

\subsection{{\AA}ngstr\"om parameters (\texttt{radex\_a}, \texttt{radex\_b})} \label{ssec:parest_rad_radex}

\textbf{Basics.}
The estimation of the {\AA}ngstr\"om parameters is based on the equation
\begin{align} \label{eq:radex1}
  \langle R_{inS} \rangle = \left (  a_s + b_s \frac{n}{N} \right ) \langle R_{ex} \rangle,
\end{align}
%
with
\begin{denseitem}
  \item[] $\langle \cdot \rangle$: daily mean of $\cdot$,
  \item[] $R_{inS}$: incoming short-wave radiation (global radiation, \verb!glorad!), in W m$^{-2}$,
  \item[] $R_{ex}$: extraterrestrial short-wave radiation (\verb!radex!), in W m$^{-2}$,
  \item[] $a_s$, $b_s$: {\AA}ngstr\"om parameters (\verb!radex_a!, \verb!radex_b!), no unit,
  \item[] $n$: sunshine duration of current day (time for which $\langle R_{inS} \rangle \geq 120~\text{W~m}^{-2}$, \verb!sundur!), in hours,
  \item[] $N$: maximum possible sunshine duration, in hours.
\end{denseitem}

\textbf{Method 1.}
Since $R_{ex}$ and $N$ are calculated internally and astronomically based, the uncertainty of the estimation through Eq.~\eqref{eq:radex1} should only depend on the observed global radiation (by definition, $n$ follows from $R_{inS}$).
Note that the equation as written represents only daily mean values of $R_{inS}$:
The parameters are weighted depending on the daily ratio $n/N$ in order to account for cloudiness.
Two special cases are therefore
\begin{align}
  a_s + b_s &= \frac{\langle R_{inS} \rangle}{\langle R_{ex} \rangle} \text{ on days when } n=N, \label{eq:radex2} \\
  a_s &= \frac{\langle R_{inS} \rangle}{\langle R_{ex} \rangle} \text{ on days when } n=0. \label{eq:radex3}
\end{align}
%
If observations for either of these cases are available, Eqs.~\eqref{eq:radex1} \& \eqref{eq:radex2} or Eqs.~\eqref{eq:radex1} \& \eqref{eq:radex3} form a system of linear equations, i.e. the unknown parameters $a_s$, $b_s$ can be found for any given day with known values of $n$ and $R_{inS}$.
Averaging over all days would then determine the parameters.
Problem: It might be difficult to find either days when $n=N$ or days when $n=0$.

\textbf{Method 2.}
Another way of estimating $a_s$ and $b_s$ based on shorter time intervals (in our case, hourly) would be
\begin{align}
  a_s + b_s &= \max_{h = 1, ..., 24} \left \{ \frac{R_{inS} (h)}{R_{ex} (h)} \right \}, \label{eq:radex4} \\
  a_s &= \min_{h = 1, ..., 24} \left \{ \frac{R_{inS} (h)}{R_{ex} (h)} \right \} \label{eq:radex5}
\end{align}
%
with
\begin{denseitem}
  \item[] $h$: hour of day.
\end{denseitem}
%
For finding unique solutions, both Eqs.~\eqref{eq:radex4} and \eqref{eq:radex5} need to be evaluated because the equations are no longer dependent on $n$.
The biggest problem of estimating the parameters with subdaily data is that extreme values (max, min) can result from measuring errors and statistical outliers.
Taking very low quantiles of the $R_{inS}/R_{ex}$ distribution and applying an upper limit for the max ($a_s + b_s$ can't be greater than 1) would probably avoid estimating $a_s$ as too low and $b_s$ as too high.

\textbf{Portugal.}
Global radiation was measured hourly at the local weather station in Portugal.
Therefore I chose to estimate \verb!radex_a! and \verb!radex_b! with Eqs.~\eqref{eq:radex4} and \eqref{eq:radex5}.
The $R_{inS}/R_{ex}$ ratio was calculcated for daytime hours between 6:00 and 18:00 local time.
This assured that only radiation between sunrise and sunset was taken into account for all of the simulation period.
For the determination of reasonable values I chose the lower 5-percentile of the $R_{inS}/R_{ex}$ distribution as the minimum and the maximum value of $\{R_{inS}/R_{ex} < 1\}$ as the maximum over the whole period in which $R_{inS}$ observations were available.
These choices proved successful in computing clear-sky radiation that didn't exceed the observed global radiation and therefore fulfilled the physical conditions.

\begin{figure}[ht]
  \centering
  \includegraphics[width=0.5\hsize]{./plot_radex1.pdf}
  \caption{Histogram of the ratio $R_{inS}/R_{ex}$ for values less than 1 in Portugal.}
  \label{fig:portugal_radex1}
\end{figure}

\begin{figure}[ht]
  \centering
  \includegraphics[width=0.6\hsize]{./plot_radex2.pdf}
  \caption{$R_{inS}/R_{ex}$ ratio dependent on hour of day.
           The shift of higher values toward early hours may indicate either a small temporal deviation between the simulated and the actual $R_{ex}$, or a local effect that weakens $R_{inS}$ during afternoon, or both.
           The dashed line marks the 5-percentile of the total distribution.}
  \label{fig:portugal_radex2}
\end{figure}

\textbf{Morocco.}
---

\section{Soil hydraulic parameters} \label{sec:parest_soil}

\verb!wc_sat!, \verb!wc_res!, \verb!wc_pwp!, \verb!wc_etmax!, \verb!bubble!, \verb!pores_ind!, \verb!wstressmin!, \verb!wstressmax!, \verb!soil_dens!, \verb!rss_a!, \verb!rss_b!.

\section{Vegetation parameters} \label{sec:parest_veg}

\verb!ext!, \verb!par_stressHum!, \verb!crop_makk!, \verb!crop_faoref!, \verb!res_leaf_min!, \verb!lai!, \verb!cano_height!.

The \textbf{Makkink crop factor} (\verb!crop_makk!) was estimated from the leaf area index by the affine relation
\begin{align} \label{eq:cropmakk}
  \text{Makkink~crop~factor} \approx 0.14 ~ LAI + 0.4
\end{align}
%
with
\begin{denseitem}
  \item[] $LAI$: leaf area index, in m$^2$ m$^{-2}$.
\end{denseitem}
%
This relation was derived in the ECHSE documentation from data of \citet{feddes87} and \citet{ludwig06}.

The \textbf{FAO crop factor} (\verb!crop_faoref!) was set to 1.
This value corresponds to the \emph{reference crop} (well-watered grass of 0.12~m height, 70~s~m$^{-1}$ surface resistance, 0.23 albedo).
Since the FAO Penman-Monteith equation is just a simplification of the Penman-Monteith equation, I preferred using the original PM model for the study cases and using the FAO reference evaporation only for a subsumption of the different models.

\subsection{Radiation for half-maximum stomatal conductance (\texttt{glo\_half})} \label{ssec:parest_veg_glohalf}

When using the PM or SW model, the modeler is interested in the bulk surface resistance of a canopy, $r_{cs}$, which is practically not measurable.
ECHSE provides two ways of calculating $r_{cs}$ from the stomatal resistance of a single average leaf, which is measurable.
If the user decides to use the formula of \citet{saugier91}, the incoming short-wave radiation at which the stomatal conductance is half of its maximum ($g_{srad}$, \verb!glo_half!) will be needed.
Note that -- since conductance is equal to inverse resistance -- this parameter corresponds to the global radiation at which the stomatal \emph{resistance} is double of its minimum value.
In their derivation of the formula, the authors assume that the actual stomatal resistance of a leaf is hyperbolically dependent on the incident short-wave radiation,
\begin{align}
  r_{l,act} = r_{l,min} \frac{R_{inS} + g_{srad}}{R_{inS}}
\end{align}
%
with
\begin{denseitem}
  \item[] $r_{l,act}$: actual stomatal resistance of one leaf, in s~m$^{-1}$,
  \item[] $r_{l,min}$: minimum stomatal resistance of one leaf, in s~m$^{-1}$,
  \item[] $R_{inS}$: incoming short-wave radiation, in W~m$^{-2}$,
  \item[] $g_{srad}$: short-wave radiation for half-maximum stomatal conductance, in W~m$^{-2}$,
\end{denseitem}
%
and that the radiation inside or under the canopy decreases exponentially as $R_{inS} \exp(-\epsilon LAI)$ with the extinction coefficient $\epsilon$, no unit, and the leaf area index $LAI$, no unit.
After integrating $r_{l,act}$ over all leaves, the resulting formula reads
\begin{align}
  r_{cs} = \epsilon r_{l,act} / \ln \frac{\epsilon R_{inS} + g_{srad}}{\epsilon R_{inS} \exp(-\epsilon LAI) + g_{srad}}.
\end{align}

The parameter of interest, $g_{srad}$, can be determined by measurements of the stomatal resistance of multiple leaves over a broad range of radiation conditions and is assumed to be specific of a species.
\citet{saugier91} collected some values,
\begin{denseitem}
  \item[--] alfalfa: 180~W~m$^{-2}$ \citep{katerji83},
  \item[--] sunflower: 200--350~W~m$^{-2}$ \citep{berger73},
  \item[--] Scots pine: 125~W~m$^{-2}$ \citep{lohammar80} and 150~W~m$^{-2}$ \citep{jarvis81},
  \item[--] apple tree: 50~W~m$^{-2}$ \citep{warrit80},
  \item[--] oil palm: 30~W~m$^{-2}$ \citep{dufrene89},
\end{denseitem}
%
which I used for the estimation of $g_{srad}$ through model calibration (?).


\subsection{Note on the calculation of the canopy resistance $r_{cs}$} \label{ssec:parest_veg_notercs}



%................................................................................

\chapter{Comparison of evapotranspiration models} \label{ch:modelcomp}

%................................................................................

\chapter{Sensitivity analysis} \label{ch:sensana}

%................................................................................

\chapter{Evaluation of ECHSE methods} \label{ch:methodcomp}

\section{Global radiation \texttt{glorad}}

\subsection{\texttt{glorad}: Portugal}

\begin{figure}[ht]
  \centering
  \includegraphics[width=0.8\hsize]{./plot_glorad_compare_portugal_HS_2014-06-26_2014-07-01.pdf}
  \caption{.}
  \label{fig:portugal_HS_glorad1}
\end{figure}

\begin{figure}[ht]
  \centering
  \includegraphics[width=0.8\hsize]{./plot_glorad_compare_portugal_NSA_2014-05-13_2014-05-20.pdf}
  \caption{.}
  \label{fig:portugal_NSA_glorad1}
\end{figure}

\subsection{\texttt{glorad}: Morocco}

\section{Net incoming radiation \texttt{rad\_net}}

\subsection{\texttt{rad\_net}: Portugal}

\begin{figure}[ht]
  \centering
  \includegraphics[width=0.8\hsize]{./plot_rad_net_compare_portugal_HS_2014-04-29_2014-07-01.pdf}
  \caption{.}
  \label{fig:portugal_HS_radnet1}
\end{figure}

\begin{figure}[ht]
  \centering
  \includegraphics[width=0.8\hsize]{./plot_rad_net_compare_portugal_NSA_2014-04-29_2014-07-01.pdf}
  \caption{.}
  \label{fig:portugal_NSA_radnet1}
\end{figure}

\section{Soilheat flux \texttt{soilheat}}

\subsection{\texttt{soilheat}: Portugal}

\begin{figure}[ht]
  \centering
  \includegraphics[width=0.8\hsize]{./plot_soilheat_compare_portugal_HS_2014-06-26_2014-07-01.pdf}
  \caption{.}
  \label{fig:portugal_HS_soilheat1}
\end{figure}

\begin{figure}[ht]
  \centering
  \includegraphics[width=0.8\hsize]{./plot_soilheat_compare_portugal_NSA_2014-05-13_2014-05-20.pdf}
  \caption{.}
  \label{fig:portugal_NSA_soilheat1}
\end{figure}


%................................................................................

\chapter{Results: overview} \label{ch:results}

\section{Parameters} \label{sec:results_par}

An overview of the parameters is given for the \textsf{paramNum} group (object-specific scalar parameters, HS Portugal: Tab. \ref{tab:portugalHS_paramNum}, NSA Portugal: Tab. \ref{tab:portugalNSA_paramNum}, Morocco: Tab.), the \textsf{sharedParamNum} group (group-specific scalar parameters, HS Portugal: Tab. \ref{tab:portugalHS_sharedParamNum}, NSA Portugal: Tab. \ref{tab:portugalNSA_sharedParamNum}, Morocco: Tab.), and the \textsf{inputExt} group (group-specific scalar parameters given as time series, HS Portugal: Tab. \ref{tab:portugalHS_inputExt}, NSA Portugal: Tab. \ref{tab:portugalNSA_inputExt}, Morocco: Tab.).

\input{portugalHS_paramNum}

\input{portugalNSA_paramNum}

\input{portugalHS_sharedParamNum}

\input{portugalNSA_sharedParamNum}

\input{portugalHS_inputExt}

\input{portugalNSA_inputExt}

%................................................................................

\chapter{Conclusion} \label{ch:conclusion}

\begin{itemize}
  \item[--] Soil heat flux needs a better model.
\end{itemize}

%................................................................................

\bibliography{../../Tex/jubib}

%................................................................................

\end{document}